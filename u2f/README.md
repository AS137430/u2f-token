# U2F firmware for STM32

U2F firmware for STM32F103 (ARM Cortex-M3).

## Installing

### Requirements

#### Build tools

Install and setup Command Line tools for Xcode on macOS.

Install build-essentials package on Debian/Ubuntu:

``` sh
sudo apt install build-essential
```

#### GNU Toolchain for ARM Embedded Processors

Installing on macOS with homebrew:

``` sh
brew tap osx-cross/arm
brew install arm-gcc-bin
```

Installing on Debian/Ubuntu:

``` sh
sudo apt install gcc-arm-none-eabi
```

#### OpenSSL

MacOS comes with openssl installed out of the box.

Installing on Debian/Ubuntu:

``` sh
sudo apt install openssl
```

#### asn1crypto

There is a tiny python script used to convert private keys generated by OpenSSL
from DER format into C-array. It depends on asn1crypto package.

To install with pip:

``` sh
pip install --user --upgrade asn1crypto
```

#### OpenOCD

Installing on macOS with homebrew:

``` sh
brew install open-ocd
```

Installing on Debian/Ubuntu:

``` sh
sudo apt install openocd
```


### Building

``` sh
cd u2f-token/u2f
```

Chopstx comes with support for multiple STM32 boards. This firmware is known to
work on Maple Mini and Blue Pill. Default target is Maple Mini. To build
firmware for Blue Pill run:

``` sh
ln -s ../board/board-blue-pill.h board.h
```

Then

```
make
```

will produce firmware file `build/u2f.elf`.


### Flashing

#### Using ST-LINK/V2 and OpenOCD

Start OpenOCD:

``` sh
openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg
```

On other terminal run:

``` sh
telnet localhost 4444
> reset halt
> stm32f1x unlock 0
> reset halt
> flash write_image erase build/u2f.elf
> stm32f1x lock 0
> reset halt
> shutdown
```

Do not flash two devices with the same binary. Currently all certificates are
built into that binary. Before flashing new device run:

``` sh
make certclean
make
```

## License

Great thanks to Niibe Yutaka author of Chopstx and Gnuk.

Copyright &copy; 2017 Sergei Glushchenko

This program is free software: you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

As additional permission under GNU GPL version 3 section 7, you may
distribute non-source form of the Program without the copy of the
GNU GPL normally required by section 4, provided you inform the
recipients of GNU GPL by a written offer.
